---
title: "Patient data prepping"
author: "Yanelli Nunez"
date: "10/13/2021"
output:
 html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: hide
editor_options: 
  chunk_output_type: console
---
Objective: 

To polish the following variables:

Residency: Reduce the number of levels of the categorical variable
Place of Birth: Reduce the number of levels of the categorical variable

Note: Inside the data folder is a dictionary for the categorical variables. The variable residency is not in this dictionary. The original data contain the equivalent of zip codes as the levels in this variable and we combined those into categories using this site: 

```{r include=FALSE}

rm(list=ls())

# 1a Declare root directory
project.folder <- paste0(print(here::here()),'/')

# add folder locations
source(paste0(project.folder,'0_00_create_folder_structure.R'))

# add file locations
source(paste0(file.locations.folder,'file_locations.R'))

# load packages
 source(paste0(packages.folder,'packages.R'))

```

## 1. Load raw patient data from Johnni

The famSES variable refers to the lowest SES category of index-person and spouse. Note that the lowest value (1) refers to highest pay job title

```{r}

load(paste0(raw_data_files, "ALS_desc_1989_2013_1989_5_2k.RData"))

patient_data <- ALS_desc_1989_2013_1989_5_2k 

summary(patient_data)
```


## 2. Summarizing place of birth into 6 categories

Categories: 

1) Copenhagen
2) Other big cities
3) Other Denmark
4) Greenland
5) Foreign
6) Unknown


```{r}

patient_data <- patient_data %>%
mutate(place_birth = case_when(geokode >= 52 & geokode <= 62 ~ "foreign",
                                 geokode == 99 | geokode == 10 ~ "unknown",
                                 geokode > 1 & geokode <= 4 ~ "other_cities",
                                 geokode == 1 ~ "copenhagen",
                                 geokode >= 5 & geokode <= 9 ~ "other_dk",
                                 geokode == 51 ~ "greenland"),
         place_birth = as.factor(place_birth))

summary(patient_data)
```


## 3. Summarizing place of residency into 5 categoties. 

Categories:

1) Greater Copenhagen
2) Big cities of Denmark > 10,000
3) Greenland
4) Rest of Denmark
5) Unknown

```{r}

# classify the residency codes

patient_data$residence <- ifelse(patient_data$postnr>=1000 & patient_data$postnr<2500, 1,                                   ifelse(patient_data$postnr==8722|patient_data$postnr==4690|patient_data$postnr==2800|patient_data$postnr==8300|patient_data$postnr==2791|patient_data$postnr==9500|patient_data$postnr==2640|patient_data$postnr==7600|patient_data$postnr==3060|patient_data$postnr==9700|patient_data$postnr==4760|patient_data$postnr==3300|patient_data$postnr==6800|patient_data$postnr==7700|patient_data$postnr==3500|patient_data$postnr==2625|patient_data$postnr==2665|patient_data$postnr==8660|patient_data$postnr==5500|patient_data$postnr==3700|patient_data$postnr==4900|patient_data$postnr==8500|patient_data$postnr==3600|patient_data$postnr==7430|patient_data$postnr==2680|patient_data$postnr==4220|patient_data$postnr==5800|patient_data$postnr==4400|patient_data$postnr==6200|patient_data$postnr==4800|patient_data$postnr==3520|patient_data$postnr==3460|patient_data$postnr==2635|patient_data$postnr==3660|patient_data$postnr==4100|patient_data$postnr==4129|patient_data$postnr==2600|patient_data$postnr==7800|patient_data$postnr==6100|patient_data$postnr==9400|patient_data$postnr==9900|patient_data$postnr==4300|patient_data$postnr==9800|patient_data$postnr==6400|patient_data$postnr==5700|patient_data$postnr==2610|patient_data$postnr==2620|patient_data$postnr==3400|patient_data$postnr==2630|patient_data$postnr==4200|patient_data$postnr==7500|patient_data$postnr==4600|patient_data$postnr==8800|patient_data$postnr==3000|patient_data$postnr==2970|patient_data$postnr==7000|patient_data$postnr==7007|patient_data$postnr==7029|patient_data$postnr==2720|patient_data$postnr==2750|patient_data$postnr==2920|patient_data$postnr==4700|patient_data$postnr==8600|patient_data$postnr==4000|patient_data$postnr==7400|patient_data$postnr==7429|patient_data$postnr==7429|patient_data$postnr==2670|patient_data$postnr==2650|patient_data$postnr==8700|patient_data$postnr==7100|patient_data$postnr==7120|patient_data$postnr==6000|patient_data$postnr==8960|patient_data$postnr==8900|patient_data$postnr==6715|patient_data$postnr==6700|patient_data$postnr==9220|patient_data$postnr==9000|patient_data$postnr==5270|patient_data$postnr==5000|patient_data$postnr==8000|patient_data$postnr==8210, 2,
ifelse(patient_data$postnr>=3900 & patient_data$postnr<3993,3,
ifelse(is.na(patient_data$postnr),5,4))) ) 

patient_data$residence <- ifelse(is.na(patient_data$postnr),5,patient_data$residence)

# label categories 
patient_data$residence<- factor(patient_data$residence,levels=c('1','2' , '3','4','5'), labels=c("Greater Copenhagen", 
         "Big cities of Denmark>10,000",
         "Greenland", 
         "Rest of Denmark",
         "Unknown"))

# View summary of variable 

table(patient_data$residence )

summary(patient_data)
```


## 4. Make a table 1

```{r}

table1_prep <- patient_data %>%
  dplyr::select(nr, lobnr, ck, sex, civst, place_birth, residence, famses) %>%
  unique() %>%
  dplyr::select(-nr, -lobnr) %>%
  mutate(ck = as.factor(if_else(ck == "0", "control", "case")),
        sex = as.factor(if_else(sex == "2", "Female", "Male")),
 famses = recode_factor(famses, 
         `1`='Group 1 (Highest)',
         `2`='Group 2',
         `3`='Group 3',
         `4`='Group 4',
         `5`='Group 5 (Lowest)',
         `9`='Group 9 (Unemployed)'),
  civst = recode_factor(civst, 
         `4`='Married',
         `3`='Divorced',
         `2`='Widower',
         `1`='Never married'),
  residence = recode_factor(residence, 
        `Greater Copenhagen`='Greater Copenhagen',
        `Big cities of Denmark>10,000`='Big cities of Denmark',
        `Rest of Denmark`='Rest of Denmark',
        `Greenland`='Greenland'),
  place_birth=recode_factor(place_birth, 
       `copenhagen`='Greater Copenhagen',
       `other_cities`='Big cities of Denmark',
       `other_dk`='Rest of Denmark',
       `greenland`='Greenland',
       `foreign`='Foreign',
       `unknown`='Unknown'))  
 
  
table_1 <- table1_prep %>%
  gtsummary::tbl_summary(#missing = "no",
              label = list(sex ~ "Sex",
                           famses ~ "Family SES",
                           place_birth ~ "Place of birth",
                           civst ~ "Civil status",
                           residence ~ "Place of residence"),
              by = ck,
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)")) %>%
              add_overall() %>%
  bold_labels()

table_1

table_1 %>%
  gtsummary::as_flex_table() %>%
  flextable::save_as_docx(path = paste0(tables.folder,'table_1_full_data.docx'))
```


## 5. Save data

```{r}
saveRDS(patient_data, file = "//fsmsph/msph_ehs$/APALS_DanishData/fromJohnni/patient_data_uniform_complete.rds")
```

